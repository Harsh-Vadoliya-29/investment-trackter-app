<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Customer Investment Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>

    <script type="module">
        import { 
            initializeApp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            onSnapshot, 
            doc, 
            updateDoc, 
            deleteDoc, 
            addDoc, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.query = query;
        window.onSnapshot = onSnapshot;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.addDoc = addDoc;
        window.setLogLevel = setLogLevel;
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const React = window.React;
        const ReactDOM = window.ReactDOM;
        const useState = React.useState;
        const useEffect = React.useEffect;
        const useRef = React.useRef;

        const firebaseConfig = {
            apiKey: "AIzaSyAYXFWuQMEwXMz-r1cpiDi3b4Hcv7Bhx5Y",
            authDomain: "my-investment-app-6514b.firebaseapp.com",
            projectId: "my-investment-app-6514b",
            storageBucket: "my-investment-app-6514b.firebasestorage.app",
            messagingSenderId: "943100607823",
            appId: "1:943100607823:web:e8eb6b434fc9b064cb593a",
            measurementId: "G-T7ZVY65S8Y"
        };
        
        const rawAppId = firebaseConfig.projectId; 
        const appId = rawAppId.replace(/[/\.]/g, '_'); 

        let app = null, globalDb = null, globalAuth = null; 
        
        if (Object.keys(firebaseConfig).length > 0) {
            try {
                app = window.initializeApp(firebaseConfig);
                globalDb = window.getFirestore(app);
                globalAuth = window.getAuth(app);
                window.setLogLevel('Debug'); 
            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        }

        const UserIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const PlusIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
        const CheckIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6 9 17l-5-5"/></svg>;
        const EditIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5L2 22l1.5-5.5L17 3z"/></svg>;
        const TrashIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
        const DollarSignIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>;
        const SearchIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>;
        const LogOutIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>;

        const InvestmentInput = React.memo(({ label, value, onChange }) => (
            <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{label} (Total Investment)</label>
                <div className="relative">
                    <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 font-bold">â‚¹</span>
                    <input
                        type="number"
                        value={String(value)}
                        onChange={(e) => onChange(e.target.value)}
                        placeholder="0"
                        min="0"
                        step="0.01"
                        required
                        className="p-3 pl-8 border border-gray-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                    />
                </div>
            </div>
        ));

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4" onClick={onClose}>
                    <div 
                        className="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all duration-300" 
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="p-6 border-b border-gray-100 flex justify-between items-center">
                            <h3 className="text-xl font-semibold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors">
                                &times;
                            </button>
                        </div>
                        <div className="p-6 max-h-[80vh] overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const CustomerForm = ({ db, collectionPath, customer, onComplete }) => {
            const isEditing = !!customer;
            
            const [name, setName] = useState(customer && customer.name || '');
            const [mobile, setMobile] = useState(customer && customer.mobile || '');
            const [licInvestment, setLicInvestment] = useState(customer && customer.investments && customer.investments.LIC || '');
            const [generalInvestment, setGeneralInvestment] = useState(customer && customer.investments && customer.investments.General || '');
            const [healthInvestment, setHealthInvestment] = useState(customer && customer.investments && customer.investments.Health || '');
            const [mutualFundInvestment, setMutualFundInvestment] = useState(customer && customer.investments && customer.investments.MutualFund || '');
            const [isLoading, setIsLoading] = useState(false);
            
            // Fix: Ref to track if the component is mounted
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => {
                    isMounted.current = false;
                };
            }, []);
            // End Fix

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!db || !collectionPath || !name || !mobile) {
                    return;
                }

                setIsLoading(true);
                
                const cleanInvestment = (val) => {
                    const num = parseFloat(String(val).replace(/[^0-9.]/g, ''));
                    return isNaN(num) ? 0 : num;
                };

                const customerData = {
                    name,
                    mobile,
                    investments: {
                        LIC: cleanInvestment(licInvestment),
                        General: cleanInvestment(generalInvestment),
                        Health: cleanInvestment(healthInvestment),
                        MutualFund: cleanInvestment(mutualFundInvestment),
                    },
                };

                try {
                    const collectionRef = window.collection(db, collectionPath);
                    
                    if (isEditing) {
                        const customerDocRef = window.doc(db, collectionRef.path, customer.id);
                        await window.updateDoc(customerDocRef, customerData);
                    } else {
                        await window.addDoc(collectionRef, {
                            ...customerData,
                            createdAt: new Date().toISOString(),
                        });
                    }
                    onComplete();
                } catch (error) {
                    console.error(`Error ${isEditing ? 'updating' : 'adding'} document:`, error);
                } finally {
                    // Fix: Only set state if the component is still mounted.
                    // onComplete() likely unmounted it.
                    if (isMounted.current) {
                        setIsLoading(false);
                    }
                }
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-6">
                    <h4 className="text-lg font-bold text-gray-800 border-b pb-2">{isEditing ? 'Edit Customer Details' : 'New Customer Record'}</h4>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input
                            type="text"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            placeholder="Customer Name (Required)"
                            required
                            className="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                        />
                        <input
                            type="tel"
                            value={mobile}
                            onChange={(e) => setMobile(e.target.value)}
                            placeholder="Mobile No (Required)"
                            required
                            className="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                        />
                    </div>

                    <div className="space-y-4 pt-4 border-t border-gray-200">
                        <h5 className="text-md font-semibold text-gray-700">Investment Totals (in â‚¹)</h5>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <InvestmentInput label="LIC/Life" value={licInvestment} onChange={setLicInvestment} />
                            <InvestmentInput label="General" value={generalInvestment} onChange={setGeneralInvestment} />
                            <InvestmentInput label="Health" value={healthInvestment} onChange={setHealthInvestment} />
                            <InvestmentInput label="Mutual Funds" value={mutualFundInvestment} onChange={setMutualFundInvestment} />
                        </div>
                    </div>

                    <button
                        type="submit"
                        disabled={isLoading}
                        className={`w-full flex justify-center items-center py-3 px-4 rounded-lg text-white font-semibold transition duration-200 shadow-md ${
                            isLoading ? 'bg-gray-500' : 'bg-indigo-600 hover:bg-indigo-700'
                        }`}
                    >
                        {isLoading ? (isEditing ? 'Saving...' : 'Adding...') : (
                            <React.Fragment>
                                <CheckIcon className="w-5 h-5 mr-2" /> {isEditing ? 'Save Changes' : 'Add Customer'}
                            </React.Fragment>
                        )}
                    </button>
                </form>
            );
        };

        const AuthLayout = ({ title, children, isLogin, setAuthView }) => (
            <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                <div className="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-gray-100">
                    <h2 className="text-3xl font-extrabold text-gray-900 text-center mb-6">{title}</h2>
                    {children}
                    <div className="mt-6 text-center text-sm">
                        {isLogin ? (
                            <p>
                                Don't have an account? 
                                <button 
                                    onClick={() => setAuthView('SIGNUP')} 
                                    className="text-indigo-600 hover:text-indigo-500 font-medium ml-1"
                                >
                                    Sign Up
                                </button>
                            </p>
                        ) : (
                            <p>
                                Already have an account? 
                                <button 
                                    onClick={() => setAuthView('LOGIN')} 
                                    className="text-indigo-600 hover:text-indigo-500 font-medium ml-1"
                                >
                                    Log In
                                </button>
                            </p>
                        )}
                    </div>
                </div>
            </div>
        );

        const LoginScreen = ({ auth, setAuthView }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            
            // Fix: Ref to track if the component is mounted
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => {
                    isMounted.current = false;
                };
            }, []);
            // End Fix

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setIsLoading(true);

                try {
                    await window.signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    // Fix: Check if mounted before setting error state
                    if (isMounted.current) {
                        let errorMessage = 'Login failed. Please check your credentials.';
                        if (err.code === 'auth/user-not-found') {
                            errorMessage = 'No account found with this email.';
                        } else if (err.code === 'auth/wrong-password') {
                            errorMessage = 'Invalid password.';
                        } else if (err.code === 'auth/invalid-email') {
                            errorMessage = 'Invalid email format.';
                        } else if (err.code === 'auth/too-many-requests') {
                            errorMessage = 'Too many failed attempts. Try again later.';
                        }
                        setError(errorMessage);
                    }
                } finally {
                    // Fix: Check if mounted before setting loading state
                    if (isMounted.current) {
                        setIsLoading(false);
                    }
                }
            };

            return (
                <AuthLayout title="Log In to Your Tracker" isLogin={true} setAuthView={setAuthView}>
                    <form onSubmit={handleLogin} className="space-y-6">
                        <input
                            type="email"
                            placeholder="Email Address"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            required
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                        />
                        <input
                            type="password"
                            placeholder="Password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            required
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                        />
                        {error && (
                            <p className="text-red-600 text-sm p-2 bg-red-100 rounded-lg border border-red-300">{error}</p>
                        )}
                        <button
                            type="submit"
                            disabled={isLoading}
                            className={`w-full py-3 rounded-lg text-white font-semibold shadow-md transition ${
                                isLoading ? 'bg-indigo-400' : 'bg-indigo-600 hover:bg-indigo-700'
                            }`}
                        >
                            {isLoading ? 'Logging In...' : 'Log In'}
                        </button>
                    </form>
                </AuthLayout>
            );
        };

        const SignupScreen = ({ auth, setAuthView }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            
            // Fix: Ref to track if the component is mounted
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => {
                    isMounted.current = false;
                };
            }, []);
            // End Fix

            const handleSignup = async (e) => {
                e.preventDefault();
                setError('');
                setIsLoading(true);

                try {
                    await window.createUserWithEmailAndPassword(auth, email, password);
                    // On success, the main component will handle the view change via onAuthStateChanged
                } catch (err) {
                    // Fix: Check if mounted before setting error state
                    if (isMounted.current) {
                        let errorMessage = 'Sign up failed.';
                        if (err.code === 'auth/email-already-in-use') {
                            errorMessage = 'This email is already registered. Try logging in.';
                        } else if (err.code === 'auth/weak-password') {
                            errorMessage = 'Password should be at least 6 characters.';
                        } else if (err.code === 'auth/operation-not-allowed') {
                            errorMessage = 'Email/Password sign-in is disabled. Please enable it in Firebase Console.';
                        } else if (err.code === 'auth/invalid-email') {
                            errorMessage = 'Invalid email format.';
                        }
                        setError(errorMessage);
                    }
                } finally {
                    // Fix: Check if mounted before setting loading state
                    if (isMounted.current) {
                        setIsLoading(false);
                    }
                }
            };

            return (
                <AuthLayout title="Create Your Secure Account" isLogin={false} setAuthView={setAuthView}>
                    <form onSubmit={handleSignup} className="space-y-6">
                        <input
                            type="email"
                            placeholder="Email Address"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            required
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                        />
                        <input
                            type="password"
                            placeholder="Password (Min 6 characters)"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            required
                            minLength="6"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                        />
                        {error && (
                            <p className="text-red-600 text-sm p-2 bg-red-100 rounded-lg border border-red-300">{error}</p>
                        )}
                        <button
                            type="submit"
                            disabled={isLoading}
                            className={`w-full py-3 rounded-lg text-white font-semibold shadow-md transition ${
                                isLoading ? 'bg-green-400' : 'bg-green-600 hover:bg-green-700'
                            }`}
                        >
                            {isLoading ? 'Signing Up...' : 'Sign Up'}
                        </button>
                    </form>
                </AuthLayout>
            );
        };

        const MainApp = () => {
            const [firestoreDb] = useState(globalDb);
            const [firebaseAuth] = useState(globalAuth);
            const [userId, setUserId] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [customers, setCustomers] = useState([]);
            const [isFormModalOpen, setIsFormModalOpen] = useState(false);
            const [customerToEdit, setCustomerToEdit] = useState(null); 
            const [searchQuery, setSearchQuery] = useState('');
            const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
            const [deleteTarget, setDeleteTarget] = useState(null);
            const [dbError, setDbError] = useState(null);

            const CUSTOMER_COLLECTION_PATH = userId ? `artifacts/${appId}/users/${userId}/customers` : null;

            useEffect(() => {
                if (!firebaseAuth) {
                    setDbError("Firebase Auth is not initialized. Check your Firebase config.");
                    setIsLoading(false);
                    return;
                }

                const unsubscribeAuth = window.onAuthStateChanged(firebaseAuth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        setUserId(null);
                    }
                    setIsLoading(false);
                });

                return () => unsubscribeAuth();
            }, [firebaseAuth]);

            useEffect(() => {
                if (!firestoreDb || !userId || !CUSTOMER_COLLECTION_PATH) return; 

                const customersColRef = window.collection(firestoreDb, CUSTOMER_COLLECTION_PATH);
                const q = window.query(customersColRef);

                const unsubscribeData = window.onSnapshot(q, (snapshot) => {
                    const customerList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        investments: doc.data().investments || { LIC: 0, General: 0, Health: 0, MutualFund: 0 }
                    }));
                    customerList.sort((a, b) => a.name.localeCompare(b.name));
                    setCustomers(customerList);
                }, (error) => {
                    console.error("Error listening to customers data:", error);
                    let errorMessage = "Data loading failed. Check Firestore rules/connection.";
                    if (error.code === 'permission-denied') {
                        errorMessage = "Permission Denied: Your Security Rules are blocking access. Ensure your rules allow read/write access ONLY if the user ID matches the path.";
                    }
                    setDbError(errorMessage);
                });

                return () => unsubscribeData();
            }, [firestoreDb, userId, CUSTOMER_COLLECTION_PATH]);

            const handleSignOut = async () => {
                try {
                    await window.signOut(firebaseAuth);
                } catch (e) {
                    console.error("Sign out error:", e);
                }
            };
            
            const filteredCustomers = customers.filter(customer => {
                if (!searchQuery) return true; 

                const query = searchQuery.toLowerCase();
                
                const nameMatch = customer.name.toLowerCase().includes(query);
                const mobileMatch = customer.mobile.toLowerCase().includes(query); 
                
                return nameMatch || mobileMatch;
            });

            const openAddModal = () => {
                setCustomerToEdit(null);
                setIsFormModalOpen(true);
            };

            const openEditModal = (customer) => {
                setCustomerToEdit(customer);
                setIsFormModalOpen(true);
            };

            const closeFormModal = () => {
                setCustomerToEdit(null);
                setIsFormModalOpen(false);
            };
            
            const openDeleteConfirmation = (customerId, customerName) => {
                setDeleteTarget({ id: customerId, name: customerName });
                setIsConfirmModalOpen(true);
            };

            const handleDeleteCustomer = async () => {
                if (!deleteTarget) return;

                const { id: customerId, name: customerName } = deleteTarget;
                
                setIsConfirmModalOpen(false);
                setDeleteTarget(null);

                try {
                    const customerDocRef = window.doc(firestoreDb, CUSTOMER_COLLECTION_PATH, customerId);
                    await window.deleteDoc(customerDocRef);
                } catch (error) {
                    console.error("Error deleting customer:", error);
                }
            };
            
            const getTotalInvestment = (investments) => {
                if (!investments) return 0;
                return (
                    (investments.LIC || 0) +
                    (investments.General || 0) +
                    (investments.Health || 0) +
                    (investments.MutualFund || 0)
                );
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR', 
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                }).format(amount);
            };

            if (isLoading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-50">
                        <div className="text-lg text-indigo-600 font-medium">Loading Application...</div>
                    </div>
                );
            }

            if (!userId) {
                return null; // Rendered by main App component if not logged in
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4 sm:p-8 font-sans">
                    <header className="mb-8 border-b pb-4 flex justify-between items-start">
                        <div>
                            <h1 className="text-3xl font-extrabold text-gray-900 flex items-center">
                                <DollarSignIcon className="w-8 h-8 mr-3 text-indigo-600" />
                                Secure Investment Tracker
                            </h1>
                            <p className="text-sm text-gray-500 mt-1">
                                Your data is **PRIVATE** and secured by email/password.
                            </p>
                        </div>
                        <button
                            onClick={handleSignOut}
                            className="flex items-center text-red-600 hover:text-red-700 py-2 px-3 rounded-lg border border-red-300 hover:bg-red-50 transition"
                            title="Sign Out"
                        >
                            <LogOutIcon className="w-5 h-5 mr-2" /> Sign Out
                        </button>
                    </header>

                    {dbError && (
                        <p className="text-sm text-red-600 mt-2 p-3 border border-red-300 bg-red-50 rounded-lg mb-6">
                            **Database Error:** {dbError}
                        </p>
                    )}

                    <div className="mb-6 flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-4">
                        <div className="relative flex-1 max-w-lg w-full">
                            <SearchIcon className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
                            <input
                                type="text"
                                placeholder="Search by Customer Name or Mobile No..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                className="w-full p-3 pl-10 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm"
                            />
                        </div>
                        
                        <button
                            onClick={openAddModal}
                            className="flex items-center justify-center bg-green-600 text-white py-3 px-6 rounded-xl font-semibold shadow-lg hover:bg-green-700 transition duration-200 transform hover:scale-[1.02] sm:w-auto"
                        >
                            <PlusIcon className="w-5 h-5 mr-2" /> Add New Customer
                        </button>
                    </div>

                    <h2 className="text-2xl font-bold text-gray-800 mb-4">Customer Records ({filteredCustomers.length} of {customers.length})</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {filteredCustomers.map((customer) => {
                            const totalInvestment = getTotalInvestment(customer.investments);
                            return (
                                <div key={customer.id} className="bg-white border border-gray-100 rounded-xl shadow-lg p-6 flex flex-col justify-between transition-shadow duration-300 hover:shadow-xl">
                                    <div>
                                        <h3 className="text-xl font-bold text-indigo-600 mb-1">{customer.name}</h3>
                                        <p className="text-sm text-gray-700 font-medium">{customer.mobile}</p>
                                        
                                        <div className="mt-4 pt-4 border-t border-gray-100">
                                            <h4 className="text-sm font-bold uppercase text-gray-500 mb-3">
                                                Total Portfolio: 
                                                <span className="text-green-600 ml-2 text-lg">
                                                    {formatCurrency(totalInvestment)}
                                                </span>
                                            </h4>

                                            <div className="space-y-1 text-sm text-gray-700">
                                                {Object.entries(customer.investments).map(([type, amount]) => (
                                                    <div key={type} className="flex justify-between border-b border-dashed pb-0.5 last:border-b-0">
                                                        <span className="font-medium text-gray-500">{type.replace(/([A-Z])/g, ' $1').trim()}:</span>
                                                        <span className="font-semibold">{formatCurrency(amount)}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="flex mt-6 space-x-2">
                                        <button 
                                            onClick={() => openEditModal(customer)}
                                            className="flex-1 flex justify-center items-center py-2 px-4 rounded-lg border border-indigo-500 text-indigo-600 text-sm font-medium hover:bg-indigo-50 transition"
                                        >
                                            <EditIcon className="w-4 h-4 mr-1" /> Edit Record
                                        </button>
                                        <button 
                                            onClick={() => openDeleteConfirmation(customer.id, customer.name)} 
                                            className="p-2 text-red-600 hover:text-red-800 transition rounded-lg hover:bg-red-50"
                                            title="Delete Customer Record"
                                        >
                                            <TrashIcon className="w-5 h-5" />
                                        </button>
                                    </div>
                                </div>
                            );
                        })}
                        {filteredCustomers.length === 0 && (
                            <div className="md:col-span-4 p-12 text-center bg-white rounded-xl shadow-inner text-gray-500">
                                <UserIcon className="w-10 h-10 mx-auto mb-3 text-gray-300" />
                                {searchQuery ? `No customers found matching "${searchQuery}".` : `No customer records found. Click "Add New Customer" to begin tracking investments.`}
                            </div>
                        )}
                    </div>

                    <Modal
                        isOpen={isFormModalOpen}
                        onClose={closeFormModal}
                        title={customerToEdit ? "Edit Customer Investment" : "Add New Customer"}
                    >
                        <CustomerForm 
                            db={firestoreDb} 
                            collectionPath={CUSTOMER_COLLECTION_PATH}
                            customer={customerToEdit}
                            onComplete={closeFormModal} 
                        />
                    </Modal>

                    <Modal
                        isOpen={isConfirmModalOpen}
                        onClose={() => setIsConfirmModalOpen(false)}
                        title="Confirm Deletion"
                    >
                        <p className="text-gray-700 mb-6">
                            Are you sure you want to permanently delete the entire record for 
                            <span className="font-semibold text-indigo-600 ml-1">{deleteTarget && deleteTarget.name}</span>? 
                            This action cannot be undone.
                        </p>
                        <div className="flex justify-end space-x-3">
                            <button
                                onClick={() => setIsConfirmModalOpen(false)}
                                className="py-2 px-4 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleDeleteCustomer}
                                className="py-2 px-4 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition"
                            >
                                Delete Permanently
                            </button>
                        </div>
                    </Modal>
                </div>
            );
        };
        
        const RootComponent = () => {
            const [authView, setAuthView] = useState('LOADING');
            const auth = globalAuth;

            useEffect(() => {
                if (!auth) {
                    setAuthView('LOGIN'); // If auth is undefined (init error), show login view
                    return;
                }
                const unsubscribe = window.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setAuthView('APP');
                    } else {
                        setAuthView('LOGIN');
                    }
                });
                return () => unsubscribe();
            }, [auth]);

            if (authView === 'LOADING') {
                 return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-50">
                        <div className="text-lg text-indigo-600 font-medium">Loading Authentication...</div>
                    </div>
                );
            }

            if (authView === 'LOGIN') {
                return <LoginScreen auth={auth} setAuthView={setAuthView} />;
            }
            if (authView === 'SIGNUP') {
                return <SignupScreen auth={auth} setAuthView={setAuthView} />;
            }
            if (authView === 'APP') {
                return <MainApp />;
            }

            return null;
        };

        const rootElement = document.getElementById('root');
        ReactDOM.render(<RootComponent />, rootElement);
    </script>
</body>
</html>
